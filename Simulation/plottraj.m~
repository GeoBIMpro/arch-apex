clear all
%% Simulation Parameters
v_d =2;
tfinal= 4;
t=[0:0.1:tfinal];
sx_0 = 0;
sy_0 = 0;

%% Quadrant I
global waypointx 
global waypointy 
waypointx = sx_0+4;
waypointy = sy_0+7;

s1=ode45(@cardynamics_pp,[0,tfinal],[0,pi/2,0,2,0,0,0,pi/2,0,0]);
figure
plot(s1.x,s1.y)
legend('beta','psi','psidot','v','sx','sy', 'delta','Psid', 'sxd', 'syd')
title('Evolution of Ego-Vehicle State Quadrant I')
xlabel('Time (s)')
ylabel('x(t)')
figure

plot(s1.y(5,:), s1.y(6,:))
hold on
plot(s1.y(9,:), s1.y(10,:))
legend('sim', 'ref')
title('Trajectory of Ego Vehicle in X-Y Plane Quadrant I')
xlabel('x (m)')
ylabel('y (m)')
hold off

%% Quadrant II
waypointx = sx_0-4;
waypointy = sy_0+7;

s2=ode45(@cardynamics_pp,[0,tfinal],[0,pi/2,0,2,0,0,0,pi/2,0,0]);
figure
plot(s2.x,s2.y)
legend('beta','psi','psidot','v','sx','sy', 'delta','Psid', 'sxd', 'syd')
title('Evolution of Ego-Vehicle State Quadrant II')
xlabel('Time (s)')
ylabel('x(t)')
figure
plot(s2.y(5,:), s2.y(6,:))
hold on
plot(s2.y(9,:), s2.y(10,:))
legend('sim', 'ref')
title('Trajectory of Ego Vehicle in X-Y Plane Quadrant II')
xlabel('x (m)')
ylabel('y (m)')
hold off

%% Quadrant III
waypointx = sx_0-4;
waypointy = sy_0-7;

% Note initial orientation and Psid init are both -pi/2 rather than pi/2
s3=ode45(@cardynamics_pp,[0,tfinal],[0,-pi/2,0,2,0,0,0,-pi/2,0,0]);
figure
plot(s3.x,s3.y)
legend('beta','psi','psidot','v','sx','sy', 'delta','Psid', 'sxd', 'syd')
title('Evolution of Ego-Vehicle State Quadrant II')
xlabel('Time (s)')
ylabel('x(t)')
figure
plot(s3.y(5,:), s3.y(6,:))
hold on
plot(s3.y(9,:), s3.y(10,:))
legend('sim', 'ref')
title('Trajectory of Ego Vehicle in X-Y Plane Quadrant III')
xlabel('x (m)')
ylabel('y (m)')
hold off

%% Quadrant IV
waypointx = sx_0+4;
waypointy = sy_0-7;

s4=ode45(@cardynamics_pp,[0,tfinal],[0,-pi/2,0,2,0,0,0,-pi/2,0,0]);
figure
plot(s4.x,s4.y)
legend('beta','psi','psidot','v','sx','sy', 'delta','Psid', 'sxd', 'syd')
title('Evolution of Ego-Vehicle State Quadrant IV')
xlabel('Time (s)')
ylabel('x(t)')
figure
plot(s4.y(5,:), s4.y(6,:))
hold on
plot(s4.y(9,:), s4.y(10,:))
legend('sim', 'ref')
title('Trajectory of Ego Vehicle in X-Y Plane Quadrant IV')
xlabel('x (m)')
ylabel('y (m)')
hold off


%% Plot
if waypointx>sx_0 && waypointy>=sy_0
    % Pure Pursuit Calculations
    l = sqrt((waypointx - sx_0)*(waypointx - sx_0) + (waypointy - sy_0)*(waypointy - sy_0));
    r = abs(l*l/(2*(waypointx - sx_0)));
    cx=sx_0+r;
    cy=sy_0;
    
    % Plot
    xQ1=cx-r*cos(v_d*t/r);
    yQ1=cy+r*sin(v_d*t/r);
    
    % Compute orientation
    normQ1 = sqrt(xQ1.^2+yQ1.^2);
    psiQ1 = asin(yQ1./normQ1);
    figure
    plot(t,psiQ1)
    hold on
    plot(s1.x,s1.y(8,:))
    title('Psi Desired Quadrant I')

elseif waypointx<sx_0 && waypointy>=sy_0
    % Pure Pursuit Calculations
    l = sqrt((waypointx - sx_0)*(waypointx - sx_0) + (waypointy - sy_0)*(waypointy - sy_0));
    r = abs(l*l/(2*(waypointx - sx_0)));
    cx=sx_0-r;
    cy=sy_0;
    
    % Plot
    xQ2=cx+r*cos(v_d*t/r);
    yQ2=cy+r*sin(v_d*t/r);
    
    % Compute orientation
    normQ2 = sqrt(xQ2.^2+yQ2.^2);
    psiQ2 = pi-asin(yQ2./normQ2);
    figure
    plot(t,psiQ2)
    hold on
    plot(s2.x,s2.y(8,:))
     title('Psi Desired Quadrant II')
end

% Pure Pursuit Calculations
l = sqrt((waypointx - sx_0)*(waypointx - sx_0) + (waypointy - sy_0)*(waypointy - sy_0));
r = abs((l*l/(2*(sx_0-waypointx))));
cx=(sx_0 - r);
cy=sy_0;

% Plot
xQ3=(cx+r*cos(v_d*t/r));
yQ3=(cy-r*sin(v_d*t/r));
% Compute orientation
normQ3 = sqrt(xQ3.^2+yQ3.^2);
psiQ3 = pi- asin(yQ3./normQ3);

figure
plot(t,psiQ3)
axis([0 tfinal 0 2*pi])
legend('psiQ3')
hold on
plot(s3.x,s3.y(8,:))
title('Psi Desired Quadrant III')
legend('Reference', 'Actual')


    
